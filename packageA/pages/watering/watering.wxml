<!--watering.wxml-->
<wxs src="../../../utils/imageUtils.wxs" module="imageUtils" />

<!-- æ ¹è§†å›¾ä½¿ç”¨fixedå®šä½å®Œå…¨è¦†ç›–æ•´ä¸ªå±å¹• -->
<view class="page-container fade-in">
  <!-- å…¨å±ç™½è‰²èƒŒæ™¯é®ç½©ï¼Œæœ€åº•å±‚ -->
  <view class="full-screen-mask"></view>
  
  <!-- æ ‘æœ¨å›¾ç‰‡å®¹å™¨ -->
  <view class="tree-container transition-ready">
    <!-- èƒŒæ™¯å›¾ç‰‡ -->
    <image 
      class="tree-image-fullscreen {{isTransitioning ? 'transitioning' : ''}} {{!treeImageLoaded ? 'loading' : ''}}"
      src="{{currentImageSrc}}"
      mode="aspectFill"
      bindload="onTreeImageLoad"
      binderror="onTreeImageError"
    />
    
    <!-- é¢„åŠ è½½å›¾ç‰‡ -->
    <image 
      class="tree-image-preload"
      src="{{nextImageSrc}}"
      mode="aspectFill"
      bindload="onNextImageLoad"
    />
    
    <!-- å‡çº§GIFå›¾å±‚ -->
    <image 
      wx:if="{{showUpgradeGif}}"
      class="tree-image-upgrade {{isUpgradeReady ? 'active' : 'inactive'}}" 
      src="{{upgradeGifSrc}}"
      mode="aspectFill"
      bindload="onUpgradeGifLoaded"
    />
    
    <!-- æ–°å¢ï¼šå°åŠ¨ç‰©ä¸¾ç‰Œå­åŠ¨ç”»å±‚ -->
    <image 
      wx:if="{{showAnimalGif}}"
      class="animal-gif-animation {{animalGifSrc.includes('animal_1.gif') || animalGifSrc.includes('animal_2.gif') || animalGifSrc.includes('animal_5.gif') || animalGifSrc.includes('animal_7.gif') ? 'animal-gif-xlarge' : 'animal-gif-large'}} {{animalGifSrc.includes('animal_1.gif') ? 'animal-1' : animalGifSrc.includes('animal_2.gif') ? 'animal-2' : animalGifSrc.includes('animal_3.gif') ? 'animal-3' : animalGifSrc.includes('animal_4.gif') ? 'animal-4' : animalGifSrc.includes('animal_5.gif') ? 'animal-5' : animalGifSrc.includes('animal_6.gif') ? 'animal-6' : animalGifSrc.includes('animal_7.gif') ? 'animal-7' : animalGifSrc.includes('animal_8.gif') ? 'animal-8' : ''}}"
      src="{{animalGifSrc}}"
      mode="aspectFit"
      wx:key="{{animalGifKey}}"
    />
    
    <!-- æ·»åŠ å°åŠ¨ç‰©ä¸¾ç‰Œå­æç¤ºæ–‡å­— -->
    <view wx:if="{{showAnimalGif && !waterResult.upgraded}}" class="animal-message">
      <text>è¿˜éœ€ {{waterResult.nextStageRemaining}} æˆé•¿å€¼åˆ°è¾¾ä¸‹ä¸€é˜¶æ®µ</text>
    </view>
  </view>
  
  <!-- æµ‡æ°´åŠ¨ç”»å®¹å™¨ï¼Œä½¿ç”¨wx:ifå’Œkeyå¼ºåˆ¶é‡æ–°æ¸²æŸ“ -->
  <block wx:if="{{isWatering}}">
    <view class="watering-animation active {{wateringAnimationActive ? 'playing' : ''}}" wx:key="{{wateringKey}}">
      <!-- æ–°çš„æµ‡æ°´GIFåŠ¨ç”» -->
      <image 
        class="watering-gif"
        src="{{wateringGif}}"
        mode="widthFix"
      />
    </view>
  </block>

  <!-- é¡¶éƒ¨å³ä¸Šè§’æ‚¬æµ®æµ‡æ°´æŒ‰é’® - æ·»åŠ åœ†åœˆæ•ˆæœ -->
  <view class="watering-can-float-btn" catch:tap="showWateringForm">
    <view class="btn-circle">
      <image 
        src="{{imageUtils.getImageUrl('/images/watering-can.png')}}" 
        class="watering-can-btn"
        mode="widthFix" />
    </view>
    <view style="position: relative; top: â€”30rpx;">
      <text class="watering-can-text">ç‚¹å‡»æµ‡æ°´</text>
    </view>
  </view>

  <!-- é¡¶éƒ¨è¿›åº¦æ¡æ‚¬æµ® -->
  <view class="growth-info-bar-top">
    <view class="stage-info-mini">
      <text class="stage-emoji-mini">{{stageEmojis[tree.stage]}}</text>
      <text class="stage-name-mini">{{stageNames[tree.stage]}}</text>
    </view>
    <view class="progress-container-mini">
      <view class="progress-bg-mini">
        <view class="progress-fill-mini {{isWatering ? 'animating' : ''}}" 
              style="width: {{getProgressPercent()}}%">
        </view>
      </view>
      <text class="progress-text-mini">{{tree.points}}/{{tree.maxPoints || 1000}}</text>
    </view>
  </view>

  <!-- å³ä¾§ä¾§è¾¹æ æ ‘æœ¨ä¿¡æ¯å¡ç‰‡ï¼ˆç®­å¤´å’Œå¡ç‰‡ä¸ºåŒä¸€ä¸ªæ§ä»¶ï¼‰ -->
  <view class="tree-info-sidebar {{showInfoCard ? 'expanded' : 'collapsed'}}" bindtap="toggleInfoCard">
    <view class="tree-info-content" wx:if="{{showInfoCard}}">
      <view class="tree-info-header">
        <text class="tree-info-emoji">{{tree.emoji || 'ğŸŒ³'}}</text>
      <text class="tree-info-title">{{tree.name}}</text>
      </view>
      <text class="tree-info-species">{{tree.species}}</text>
      <text class="tree-info-desc">{{tree.description}}</text>
      <text class="tree-info-id">æ ‘æœ¨ID: {{currentTreeId}}</text>
    </view>
  </view>

  <!-- æœ€æ–°åŠ¨æ€åŒºåŸŸ - æ”¹ä¸ºä¸Šæ‹‰åŠ¨æ€æ¡† -->
  <view class="activity-feed">
    <view class="activity-title">æœ€æ–°åŠ¨æ€</view>
    <scroll-view class="activity-list" scroll-y="true" style="max-height: 110rpx;">
      <view class="activity-item" wx:for="{{activityList}}" wx:key="id">
        <image class="activity-avatar" src="{{item.avatar}}" mode="aspectFill"/>
        <view class="activity-content">
          <text class="activity-nickname">{{item.nickname}}</text>
          <text class="activity-action">{{item.action}}</text>
          <text class="activity-time">{{item.time}}</text>
        </view>
      </view>
    </scroll-view>
    <view class="pull-indicator">ä¸Šæ‹‰æŸ¥çœ‹æ›´å¤š</view>
  </view>
</view>

<!-- æµ‡æ°´è¡¨å•å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showWateringForm}}">
  <view class="modal-inner">
    <view class="form-header">
      <text class="form-title">çˆ±å¿ƒæµ‡æ°´</text>
      <text class="form-price">Â¥70.00</text>
    </view>
    
    <view class="form-body">
      <!-- æ–°å¢ï¼šåŒ¿å/å®åé€‰æ‹© -->
      <view class="form-item">
        <text class="form-label">æ˜¾ç¤ºæ–¹å¼</text>
        <radio-group class="radio-group" bindchange="onDisplayTypeChange">
          <label class="radio-item">
            <radio value="real" checked="{{!formData.isAnonymous}}" color="#07c160" />
            <text class="radio-text">å®å</text>
          </label>
          <label class="radio-item">
            <radio value="anonymous" checked="{{formData.isAnonymous}}" color="#07c160" />
            <text class="radio-text">åŒ¿å</text>
          </label>
        </radio-group>
      </view>
      
      <!-- å§“åè¾“å…¥æ¡†ï¼Œæ ¹æ®åŒ¿åçŠ¶æ€æ˜¾ç¤º/éšè— -->
      <view class="form-item" wx:if="{{!formData.isAnonymous}}">
        <text class="form-label">å§“å</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" bindinput="inputName" value="{{formData.name}}"/>
      </view>
      
      <view class="form-item">
        <text class="form-label">ç•™è¨€</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥ç•™è¨€ï¼ˆé€‰å¡«ï¼‰" bindinput="inputMessage" value="{{formData.message}}"/>
      </view>
      
      <view class="form-info">
        <text class="info-text">æ¯æ¬¡æµ‡æ°´å°†ä¸ºæ ‘æœ¨å¢åŠ æˆé•¿å€¼</text>
        <text class="info-text">æ‚¨çš„çˆ±å¿ƒå°†ç”¨äºæ ¡å›­ç»¿åŒ–å»ºè®¾</text>
      </view>
    </view>
    
    <!-- ä¿®æ”¹æŒ‰é’®å®¹å™¨ -->
    <view class="form-actions-compact">
      <button class="modal-btn cancel-btn" bindtap="cancelWatering">å–æ¶ˆ</button>
      <button class="modal-btn pay-btn" bindtap="startPayment">å¾®ä¿¡æ”¯ä»˜</button>
    </view>
  </view>
</view>

<!-- æµ‡æ°´ç»“æœå¼¹çª— -->
<view class="modal" wx:if="{{showResult}}">
  <view class="modal-content">
    
    <view class="result-body">
      <view class="result-icon">{{waterResult.upgraded ? 'ğŸ‰' : 'ğŸ’§'}}</view>
      <view class="result-message">
        <text wx:if="{{waterResult.upgraded}}">æ­å–œï¼æ ‘æœ¨å·²å‡çº§è‡³ {{waterResult.stageName}}</text>
        <text wx:else>æ ‘æœ¨æˆé•¿å€¼ +{{waterResult.pointsGained}}</text>
      </view>
      
      <view class="result-stats">
        <view class="result-stat-item">
          <text class="stat-label">æœ¬æ¬¡æµ‡æ°´</text>
          <text class="stat-value">{{waterResult.wateringAmount}}æ¡¶æ°´</text>
        </view>
        <view class="result-stat-item">
          <text class="stat-label">ç´¯è®¡æµ‡æ°´</text>
          <text class="stat-value">{{waterResult.totalWateringCount}}æ¬¡</text>
        </view>
        <view class="result-stat-item">
          <text class="stat-label">æ€»æµ‡æ°´é‡</text>
          <text class="stat-value">{{waterResult.totalWateringAmount}}æ¡¶æ°´</text>
        </view>
        <view class="result-stat-item">
          <text class="stat-label">æ€»æˆé•¿å€¼</text>
          <text class="stat-value">{{waterResult.totalGrowthValue}}</text>
        </view>
      </view>
      
      <view class="next-stage-info" wx:if="{{!waterResult.upgraded}}">
        <text class="next-stage-text">è·ç¦»ä¸‹ä¸€é˜¶æ®µè¿˜éœ€ {{waterResult.nextStageRemaining}} æˆé•¿å€¼</text>
      </view>
      
      <view class="certificate-link" bindtap="downloadCertificate">
        <text class="certificate-icon">ğŸ“œ</text>
        <text class="certificate-text">ç‚¹å‡»ä¸‹è½½æµ‡æ°´è¯ä¹¦</text>
      </view>
    </view>
    
    <view class="result-footer">
      <button class="result-btn continue" bindtap="continueWatering">ç»§ç»­æµ‡æ°´</button>
      <button class="result-btn close" bindtap="closeResult">å…³é—­</button>
    </view>
  </view>
</view>

<!-- è¯ä¹¦å¼¹çª— -->
<view class="certificate-modal" wx:if="{{showCertificate}}" catchtouchmove="preventTouchMove">
  <view class="certificate-container">
    <view class="certificate-header">
      <text class="certificate-title">æµ‡æ°´è¯ä¹¦</text>
      <text class="close-btn" bindtap="closeCertificate">Ã—</text>
    </view>

    <view class="certificate-content">
      <view class="certificate-image-container" id="cert-container">
        <image src="{{imageUtils.getImageUrl('/images/certificate-bg.jpg')}}" mode="widthFix" class="certificate-bg"></image>

        <!-- è¯ä¹¦ç¼–å· -->
        <view class="certificate-number" id="cert-number">NO.{{currentCertificate.certNumber}}</view>
        
        <!-- ç”¨æˆ·å -->
        <view class="certificate-name" id="cert-name">{{currentCertificate.name}}</view>

        <!-- æ—¥æœŸ -->
        <view class="certificate-date" id="cert-date">
          <text class="certificate-year" id="cert-year">{{currentCertificate.year}}</text>
          <text class="certificate-month" id="cert-month">{{currentCertificate.month}}</text>
          <text class="certificate-day" id="cert-day">{{currentCertificate.day}}</text>
        </view>
      </view>
    </view>

    <view class="certificate-footer">
      <button class="save-btn" bindtap="saveCertificate">ä¿å­˜è¯ä¹¦åˆ°ç›¸å†Œ</button>
    </view>
  </view>
</view> 

<!-- å¼ºåˆ¶æ˜¾ç¤ºçš„å¼¹çª— -->
<view class="force-modal" wx:if="{{showResult}}" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:999999; display:flex; justify-content:center; align-items:center;">
  <view style="background:white; width:80%; max-width:600rpx; border-radius:20rpx; overflow:hidden; box-shadow:0 4rpx 20rpx rgba(0,0,0,0.2);">
    <view style="background:#4CAF50; color:white; padding:20rpx; text-align:center;">
      <text style="font-size:36rpx; font-weight:bold;">{{waterResult.upgraded ? 'æ­å–œå‡çº§ï¼' : 'æµ‡æ°´æˆåŠŸï¼'}}</text>
    </view>
    
    <view style="padding:30rpx;">
      <view style="font-size:60rpx; text-align:center; margin-bottom:20rpx;">{{waterResult.upgraded ? 'ğŸ‰' : 'ğŸ’§'}}</view>
      <view style="text-align:center; font-size:32rpx; font-weight:bold; color:#333; margin-bottom:30rpx;">
        <text wx:if="{{waterResult.upgraded}}">æ­å–œï¼æ ‘æœ¨å·²å‡çº§è‡³ {{waterResult.stageName}}</text>
        <text wx:else>æ ‘æœ¨æˆé•¿å€¼ +{{waterResult.pointsGained}}</text>
      </view>
      
      <view style="background:#f8f8f8; border-radius:10rpx; padding:20rpx; margin-bottom:20rpx; display:flex; flex-wrap:wrap;">
        <view style="width:50%; padding:10rpx; box-sizing:border-box;">
          <text style="font-size:24rpx; color:#666; display:block;">æœ¬æ¬¡æµ‡æ°´</text>
          <text style="font-size:28rpx; color:#4CAF50; font-weight:bold;">{{waterResult.wateringAmount}}æ¡¶æ°´</text>
        </view>
        <view style="width:50%; padding:10rpx; box-sizing:border-box;">
          <text style="font-size:24rpx; color:#666; display:block;">ç´¯è®¡æµ‡æ°´</text>
          <text style="font-size:28rpx; color:#4CAF50; font-weight:bold;">{{waterResult.totalWateringCount}}æ¬¡</text>
        </view>
        <view style="width:50%; padding:10rpx; box-sizing:border-box;">
          <text style="font-size:24rpx; color:#666; display:block;">æ€»æµ‡æ°´é‡</text>
          <text style="font-size:28rpx; color:#4CAF50; font-weight:bold;">{{waterResult.totalWateringAmount}}æ¡¶æ°´</text>
        </view>
        <view style="width:50%; padding:10rpx; box-sizing:border-box;">
          <text style="font-size:24rpx; color:#666; display:block;">æ€»æˆé•¿å€¼</text>
          <text style="font-size:28rpx; color:#4CAF50; font-weight:bold;">{{waterResult.totalGrowthValue}}</text>
        </view>
      </view>
      
      <view wx:if="{{!waterResult.upgraded}}" style="text-align:center; margin:20rpx 0;">
        <text style="font-size:26rpx; color:#FF9800;">è·ç¦»ä¸‹ä¸€é˜¶æ®µè¿˜éœ€ {{waterResult.nextStageRemaining}} æˆé•¿å€¼</text>
      </view>
      
      <view bindtap="downloadCertificate" style="background:#e3f2fd; border:2rpx solid #2196F3; border-radius:10rpx; padding:20rpx; margin-top:20rpx; display:flex; align-items:center; justify-content:center; box-shadow: 0 2rpx 8rpx rgba(33, 150, 243, 0.2); active:opacity:0.8;">
        <text style="font-size:40rpx; margin-right:10rpx;">ğŸ“œ</text>
        <text style="color:#2196F3; font-size:28rpx; font-weight:bold;">ç‚¹å‡»ä¸‹è½½æµ‡æ°´è¯ä¹¦</text>
      </view>
    </view>
    
    <view style="display:flex; border-top:1rpx solid #eee;">
      <button bindtap="continueWatering" style="flex:1; border:none; border-radius:0; padding:20rpx; font-size:30rpx; background:#4CAF50; color:white;">ç»§ç»­æµ‡æ°´</button>
      <button bindtap="closeResult" style="flex:1; border:none; border-radius:0; padding:20rpx; font-size:30rpx; background:#f5f5f5; color:#666;">å…³é—­</button>
    </view>
  </view>
</view> 

<!-- éšè—çš„ä¸´æ—¶canvasï¼Œç”¨äºä¿å­˜å›¾ç‰‡ -->
<canvas canvas-id="tempCanvas" style="position: absolute; left: -9999px; width: 1187px; height: 830px;"></canvas> 