<!-- å…¨æ–°è®¾è®¡çš„æˆ‘çš„æ ‘æœ¨é¡µé¢ -->
<wxs src="../../../utils/imageUtils.wxs" module="imageUtils" />

<view class="modern-container">
  <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="hero-card">
    <view class="hero-background">
      <view class="hero-pattern"></view>
    </view>
    <view class="hero-content">
      <view class="user-profile">
        <!-- å¤´åƒéƒ¨åˆ†ï¼šå§‹ç»ˆå¯ä»¥ç‚¹å‡»æ›´æ¢ -->
        <view class="avatar-container">
          <button class="avatar-button" 
                  open-type="chooseAvatar" 
                  bind:chooseavatar="onChooseAvatar">
            <image class="user-avatar" src="{{userInfo.avatarUrl || '../../images/default-avatar.png'}}" mode="aspectFill" binderror="onAvatarError" />
            <view class="avatar-overlay" wx:if="{{!userInfo.avatarUrl}}">
              <text class="avatar-text">ç‚¹å‡»è®¾ç½®å¤´åƒ</text>
            </view>
          </button>
        </view>
        
        <!-- ç”¨æˆ·ä¿¡æ¯éƒ¨åˆ† -->
        <view class="user-info">
          <!-- æ˜µç§°ï¼šå§‹ç»ˆå¯ä»¥ç‚¹å‡»ç¼–è¾‘ -->
          <view class="nickname-edit">
            <input class="nickname-input" 
                   type="nickname" 
                   placeholder="ç‚¹å‡»è¾“å…¥æ˜µç§°" 
                   value="{{userInfo.nickName === 'å¾®ä¿¡ç”¨æˆ·' ? '' : userInfo.nickName}}" 
                   bind:change="onNicknameChange" />
          </view>
          <text class="user-title">ğŸŒ± ç¯ä¿å®ˆæŠ¤è€…</text>
        </view>
      </view>
      <view class="achievement-badge">
        <text class="badge-number">{{statistics.waterCount}}</text>
        <text class="badge-label">æ¬¡æµ‡æ°´</text>
      </view>
      
      <!-- è°ƒè¯•æŒ‰é’® - å·²éšè— -->
      <!-- <view class="debug-toggle" bindtap="showDebugPanel" style="position: absolute; top: 20rpx; right: 20rpx; background: #ff5722; color: white; padding: 8rpx 16rpx; border-radius: 20rpx; font-size: 20rpx; z-index: 100;">
        ğŸ”§ è°ƒè¯•
      </view> -->
    </view>
  </view>

  <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-grid">
    <view class="stat-card">
      <view class="stat-icon">ğŸŒ³</view>
      <view class="stat-content">
        <text class="stat-number">{{statistics.treeCount}}</text>
        <text class="stat-label">å®ˆæŠ¤æ ‘æœ¨</text>
      </view>
    </view>
    <view class="stat-card">
      <view class="stat-icon">ğŸ’§</view>
      <view class="stat-content">
        <text class="stat-number">{{statistics.waterCount || 0}}</text>
        <text class="stat-label">æ¡¶æ°´</text>
      </view>
    </view>
    <view class="stat-card">
      <view class="stat-icon">â­</view>
      <view class="stat-content">
        <text class="stat-number">{{statistics.totalGrowth || 0}}</text>
        <text class="stat-label">æˆé•¿å€¼</text>
      </view>
    </view>
  </view>

  <!-- ç°ä»£åŒ–æ ‡ç­¾å¯¼èˆª -->
  <view class="modern-tabs">
    <view class="tab-item {{item.active ? 'active' : ''}}" 
          wx:for="{{tabs}}" 
          wx:key="id" 
          data-id="{{item.id}}" 
          bindtap="switchTab">
      <text class="tab-icon">{{item.icon}}</text>
      <text class="tab-text">{{item.name}}</text>
      <view class="tab-indicator" wx:if="{{item.active}}"></view>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-area">
    
    <!-- æµ‡æ°´è®°å½• -->
    <scroll-view class="record-scroll" wx:if="{{activeTab === 'all' || activeTab === 'my'}}" 
                 scroll-y="{{true}}" enhanced="{{true}}" bounces="{{true}}">
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{(activeTab === 'all' && allWateringRecords.length === 0) || (activeTab === 'my' && myWateringRecords.length === 0)}}">
        <view class="empty-icon">ğŸŒ±</view>
        <text class="empty-title">æš‚æ— æµ‡æ°´è®°å½•</text>
        <text class="empty-subtitle">å»ç»™æ ‘æœ¨æµ‡æ°´å§ï¼</text>
      </view>

      <!-- è®°å½•å¡ç‰‡ -->
      <view class="record-card" 
            wx:for="{{activeTab === 'all' ? allWateringRecords : myWateringRecords}}" 
            wx:key="timestamp">
        <view class="record-header">
          <view class="record-user">
            <image class="record-avatar" src="{{item.userAvatar || item.avatar || '../../images/default-avatar.png'}}" mode="aspectFill" />
            <view class="record-user-info">
              <text class="record-username">{{item.userName || item.name || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="record-time">{{item.date}} {{item.time}}</text>
            </view>
          </view>
          <view class="record-amount">
            <text class="amount-number">+{{item.growthValue || 70}}</text>
            <text class="amount-label">æˆé•¿å€¼</text>
          </view>
        </view>
        
        <view class="record-body">
          <view class="record-tree-info">
            <view class="tree-icon-badge">{{item.treeEmoji || 'ğŸŒ³'}}</view>
            <view class="tree-details">
              <text class="tree-name">{{(item.region ? item.region + ' ' : '') + (item.treeId || item.id || item.treeName || 'æ ‘æœ¨')}}</text>
              <text class="tree-location">ğŸ“ {{item.region || ''}}</text>
            </view>
          </view>
          
          <view class="record-message" wx:if="{{item.message}}">
            <view class="message-bubble">
              <text class="message-text">"{{item.message}}"</text>
            </view>
          </view>
        </view>
        
        <view class="record-footer">
          <view class="record-stats">
            <text class="water-stat">ğŸ’§ {{item.waterAmount || 1}}æ¡¶æ°´</text>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- æ ¡å‹æ—ä¸“åŒº -->
    <scroll-view class="alumni-forest-scroll" wx:if="{{activeTab === 'alumni'}}" 
                 scroll-y="{{true}}" enhanced="{{true}}" bounces="{{true}}">
      
      <!-- æ ¡å‹æ—ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="forest-stats-header">
        <view class="forest-title">
          <text class="title-icon">ğŸ“</text>
          <text class="title-text">æ ¡å‹æ—</text>
          <text class="title-subtitle">ä¸ƒåè½½æ ¡å‹æƒ…æ·±ï¼Œ2100æ£µæ ‘æœ¨è§è¯</text>
        </view>
        
        <view class="era-stats-grid">
          <view class="era-stat-card" wx:for="{{alumniForestStats.zones}}" wx:key="zone">
            <text class="era-zone">{{item.zone}}åŒº</text>
            <text class="era-period">{{item.era}}</text>
            <text class="era-count">{{item.count}}æ£µ</text>
            <text class="era-range">ç¼–å· {{item.range}}</text>
          </view>
        </view>
      </view>

      
    </scroll-view>

    <!-- åå¸ˆæ—ä¸“åŒº -->
    <scroll-view class="master-forest-scroll" wx:if="{{activeTab === 'master'}}" 
                 scroll-y="{{true}}" enhanced="{{true}}" bounces="{{true}}">
      
      <!-- åå¸ˆæ—ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="forest-stats-header">
        <view class="forest-title">
          <text class="title-icon">ğŸ‘¨â€ğŸ«</text>
          <text class="title-text">åå¸ˆæ—</text>
          <text class="title-subtitle">å¸ˆè€…é£èŒƒï¼Œæ¡ƒææ»¡å¤©ä¸‹</text>
        </view>
        
        <view class="master-stats-grid">
          <view class="master-stat-card">
            <text class="stat-title">å—å¤§é—¨å¹¿åœº</text>
            <text class="stat-desc">æŒºæ‹”é›ªæ¾ 26æ£µ</text>
            <text class="stat-meaning">å½°æ˜¾å­¦åºœåº„é‡æ°”è±¡</text>
          </view>
          <view class="master-stat-card">
            <text class="stat-title">å›¾æ–‡ä¸­å¿ƒåŒ—ä¾§</text>
            <text class="stat-desc">è‹åŠ²é›ªæ¾ 10æ£µ</text>
            <text class="stat-meaning">å®ˆæŠ¤çŸ¥è¯†æ®¿å ‚</text>
          </view>
          <view class="master-stat-card">
            <text class="stat-title">å†…åº­é™¢</text>
            <text class="stat-desc">ä¼˜é›…é“¶æ 30æ£µ</text>
            <text class="stat-meaning">æå›èŠ¬èŠ³ï¼Œé‡‘ç§‹ç¡•æœ</text>
          </view>
          <view class="master-stat-card">
            <text class="stat-title">å›¾æ–‡ä¸­å¿ƒå—ä¾§</text>
            <text class="stat-desc">å¸¸é’æ²¹æ¾ 4æ£µ</text>
            <text class="stat-meaning">å¸ˆé“é•¿å­˜ï¼ŒåŸºä¸šé•¿é’</text>
          </view>
        </view>
      </view>

     
    </scroll-view>

    <!-- æ™®é€šæ ‘æœ¨å±•ç¤º -->
    <scroll-view class="trees-scroll" wx:if="{{activeTab === 'trees'}}" 
                 scroll-y="{{true}}" enhanced="{{true}}" bounces="{{true}}">
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{trees.length === 0}}">
        <view class="empty-icon">ğŸŒ²</view>
        <text class="empty-title">æš‚æ— å®ˆæŠ¤æ ‘æœ¨</text>
        <text class="empty-subtitle">å»è®¤å…»ä¸€æ£µæ ‘å§ï¼</text>
      </view>

      <!-- æ ‘æœ¨å¡ç‰‡ç½‘æ ¼ -->
      <view class="trees-grid">
        <view class="tree-card" wx:for="{{trees}}" wx:key="id" bindtap="viewTreeDetail" data-tree="{{item}}">
          <view class="tree-card-header">
            <view class="tree-emoji">{{item.emoji || 'ğŸŒ³'}}</view>
            <view class="tree-stage-badge">
              <text class="stage-text">{{item.stageName || 'å¹¼è‹—'}}</text>
            </view>
          </view>
          
          <view class="tree-card-body">
            <text class="tree-name">{{item.region || 'åå¸ˆæ—'}} {{item.treeId || item.id}}</text>
            <text class="tree-species">{{item.species || ''}}</text>
            <text class="tree-location" wx:if="{{item.region}}">ğŸ“ {{item.region}}</text>
          </view>
          
          <view class="tree-progress-section">
            <view class="progress-header">
              <text class="progress-label">æˆé•¿è¿›åº¦</text>
              <text class="progress-numbers">{{item.points || 0}}/{{item.maxPoints || 100}}</text>
            </view>
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{(item.points || 0) / (item.maxPoints || 100) * 100}}%"></view>
            </view>
          </view>
          
          <view class="tree-stats-row">
            <view class="tree-stat-item">
              <text class="stat-icon">ğŸ’§</text>
              <text class="stat-text">{{item.waterCount || 0}}æ¬¡</text>
            </view>
            <view class="tree-stat-item">
              <text class="stat-icon">ğŸ“ˆ</text>
              <text class="stat-text">{{item.totalGrowth || 0}}æˆé•¿å€¼</text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  

  

  <!-- å¼€å‘è°ƒè¯•é¢æ¿ - å·²éšè— -->
  <!-- <view class="debug-panel" wx:if="{{showDebug}}">
    <view class="debug-header" bindtap="toggleDebug">
      <text class="debug-title">ğŸ”§ è°ƒè¯•é¢æ¿</text>
    </view>
    <view class="debug-content" wx:if="{{debugExpanded}}">
      <button class="debug-btn" bindtap="resetData" size="mini">é‡ç½®æ•°æ®</button>
      <button class="debug-btn" bindtap="syncFromDatabase" size="mini">ä»æ•°æ®åº“åŒæ­¥</button>
      <button class="debug-btn" bindtap="testDatabaseConnection" size="mini">æµ‹è¯•æ•°æ®åº“</button>
      <button class="debug-btn" bindtap="checkTreeData" size="mini">æ£€æŸ¥æ ‘æœ¨æ•°æ®</button>
      <button class="debug-btn" bindtap="resetAllTreesData" size="mini" style="background: #ff5722; color: white;">é‡ç½®æ‰€æœ‰æ ‘æœ¨</button>
      <text class="debug-info">æµ‡æ°´è®°å½•: {{allWateringRecords.length}}æ¡ | æˆ‘çš„è®°å½•: {{myWateringRecords.length}}æ¡ | æ ‘æœ¨: {{trees.length}}æ£µ</text>
    </view>
  </view> -->
</view>