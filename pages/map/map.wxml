<!-- åœ°å›¾é¡µé¢ - å®Œæ•´äº¤äº’ç‰ˆ -->
<view class="page">
  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="tree-search-bar">
    <input class="search-input" placeholder="è¾“å…¥æ ‘æœ¨ç¼–å·å®šä½ (å¦‚ 27)" value="{{searchTreeId}}" bindinput="onInputTreeId" />
    <button class="search-btn" bindtap="onSearchTree">æœç´¢</button>
  </view>

  <!-- åœ°å›¾å®¹å™¨ -->
  <view class="map-container">
    <!-- å¯æ»šåŠ¨åœ°å›¾åŒºåŸŸ -->
    <scroll-view class="map-scroll-view" scroll-x="true" scroll-y="true" scroll-left="{{scrollLeft}}" scroll-top="{{scrollTop}}">
      <!-- ç¼©æ”¾åŒ…è£…å™¨ï¼ˆç”±æ ·å¼ transform: scale æ§åˆ¶ï¼‰ -->
      <view class="map-wrapper" style="width: {{mapWidth}}rpx; height: {{mapHeight}}rpx; transform: scale({{mapScale}});">
        <!-- åœ°å›¾åº•å›¾ï¼ˆè¿œç¨‹å¯¹è±¡å­˜å‚¨ï¼‰ -->
        <image class="map-image" src="https://636c-cloudbase-8geef97fbe06f6f1-1371111601.tcb.qcloud.la/images/images/campus-map.jpg" mode="widthFix" bindload="onImageLoad" binderror="onImageError" />

        <!-- æ ‘æœ¨ç‚¹ä½è¦†ç›–å±‚ -->
        <view class="map-trees">
          <block wx:for="{{mapTrees}}" wx:key="id">
            <view class="map-tree interactive" style="left: {{item.mapX}}rpx; top: {{item.mapY}}rpx;" data-tree-id="{{item.id}}" bindtap="onMapTreeTap">
              <text class="tree-emoji">{{item.emoji}}</text>
            </view>
          </block>
        </view>
      </view>
    </scroll-view>

    <!-- å³ä¾§æ§åˆ¶æŒ‰é’® -->
    <view class="map-controls">
      <view class="control-btn" bindtap="resetZoom"><text class="control-icon">âŸ³</text></view>
      <view class="control-btn" bindtap="locateUser"><text class="control-icon">ğŸ“</text></view>
      <view class="control-btn" bindtap="goToMyTrees"><text class="control-icon">ğŸŒ³</text></view>
    </view>

    <!-- å·¦ä¸‹è§’æ—åŒºåˆ‡æ¢æŒ‰é’® -->
    <view class="region-btn" bindtap="toggleRegionSelection">
      <text class="control-icon">ğŸ </text>
    </view>
  </view>

  <!-- åº•éƒ¨æ—åŒºé€‰æ‹©é¢æ¿ï¼ˆå¤ç”¨ç°æœ‰å¼¹çª—æ ·å¼ä¸é€»è¾‘ï¼‰ -->
  <view wx:if="{{showRegionSelection}}" class="forest-selection-modal" bindtap="hideRegionSelection" catchtouchmove="true">
    <view class="forest-modal-content" catchtap="stopPropagation">
      <view class="forest-modal-header">
        <text class="forest-modal-title">åˆ‡æ¢æ—åŒº</text>
      </view>
      <view class="forest-modal-body">
        <view class="forest-options">
          <view class="forest-option" data-forest="famous-teacher-forest" bindtap="selectForest">
            <text class="forest-emoji">ğŸŒ²</text>
            <text class="forest-name">åå¸ˆæ—</text>
            <text class="forest-desc">åå¸ˆå®ˆæŠ¤å‚ä¸åŒºåŸŸ</text>
          </view>
          <view class="forest-option" data-forest="alumni-forest" bindtap="openAlumniPicker">
            <text class="forest-emoji">ğŸŒ³</text>
            <text class="forest-name">æ ¡å‹æ—</text>
            <text class="forest-desc">æ ¡å‹å‚ä¸åŒºåŸŸ</text>
          </view>
        </view>
        <text class="forest-tip">ç‚¹å‡»ç©ºç™½å¤„å¯å…³é—­</text>
      </view>
    </view>
  </view>

  <!-- æ ¡å‹æ—é€‰æ‹©å™¨ï¼ˆä¸ my-trees äº¤äº’ä¸€è‡´ï¼‰ -->
  <view wx:if="{{showAlumniPicker}}" class="forest-selection-modal" bindtap="closeAlumniPicker" catchtouchmove="true">
    <view class="forest-modal-content" catchtap="stopPropagation">
      <view class="forest-modal-header">
        <text class="forest-modal-title">é€‰æ‹©æ ¡å‹æ—å¹´ä»½ä¸ç¼–å·</text>
        <text class="close-btn" bindtap="closeAlumniPicker">Ã—</text>
      </view>
      <view class="forest-modal-body">
        <view class="alumni-selector">
          <picker mode="selector" range="{{alumniForestStats.zones}}" range-key="era" value="{{alumniSelection.zoneIndex}}" bindchange="onAlumniZoneChange">
            <view class="picker-block">
              <view class="picker-label">é€‰æ‹©å¹´ä»£ï¼š</view>
              <view class="picker-value">{{alumniForestStats.zones[alumniSelection.zoneIndex].era}}ï¼ˆ{{alumniForestStats.zones[alumniSelection.zoneIndex].range}}ï¼‰</view>
            </view>
          </picker>

          <view class="number-field">
            <view class="number-label">é€‰æ‹©ç¼–å·ï¼š</view>
            <input class="number-input" type="number" placeholder="è¾“å…¥ç¼–å·ï¼ˆå¦‚ 350ï¼‰" value="{{alumniSelection.number}}" bindinput="onAlumniNumberInput"/>
          </view>

          <view class="actions">
            <button class="confirm-btn" bindtap="confirmAlumniSelection">å‰å¾€è¯¦æƒ…</button>
          </view>

          <view class="helper-text">ç¼–å·éœ€è½åœ¨æ‰€é€‰å¹´ä»£åŒºé—´å†…</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆå§‹æ—åŒºé€‰æ‹©å¼¹çª— -->
  <view wx:if="{{showForestSelectionModal}}" class="forest-selection-modal" catchtouchmove="true">
    <view class="forest-modal-content">
      <view class="forest-modal-header">
        <text class="forest-modal-title">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„æ—åŒº</text>
      </view>
      <view class="forest-modal-body">
        <view class="forest-options">
          <view class="forest-option" data-forest="famous-teacher-forest" bindtap="selectForest">
            <text class="forest-emoji">ğŸŒ²</text>
            <text class="forest-name">åå¸ˆæ—</text>
            <text class="forest-desc">åå¸ˆå®ˆæŠ¤å‚ä¸åŒºåŸŸ</text>
          </view>
          <view class="forest-option" data-forest="alumni-forest" bindtap="selectForest">
            <text class="forest-emoji">ğŸŒ³</text>
            <text class="forest-name">æ ¡å‹æ—</text>
            <text class="forest-desc">æ ¡å‹å‚ä¸åŒºåŸŸ</text>
          </view>
        </view>
        <text class="forest-tip">å¯åœ¨å·¦ä¸‹è§’ğŸ æŒ‰é’®éšæ—¶åˆ‡æ¢</text>
      </view>
    </view>
  </view>

  <!-- æ ‘æœ¨è¯¦æƒ…å¼¹çª— -->
  <view wx:if="{{showTreeDetail}}" class="tree-detail-modal" catchtouchmove="true">
    <view class="modal-content">
      <view class="modal-header">
        <text class="tree-title">æ ‘æœ¨ç¼–å·ï¼š{{treeDetailData.id}}</text>
        <view class="header-right">
          <text class="region-chip">{{treeDetailData.region}}</text>
          <view class="close-x" bindtap="closeTreeDetail">Ã—</view>
        </view>
      </view>
      <view class="modal-body">
        <view class="tree-info info-grid">
          <view class="info-item"><text class="label">æ‰€å±</text><text class="value">{{treeDetailData.region}}</text></view>
          <view class="info-item"><text class="label">æ ‘ç§</text><text class="value">{{treeDetailData.type}}</text></view>
          <view class="info-item"><text class="label">æœ€è¿‘æµ‡æ°´</text><text class="value">{{treeDetailData.lastWatered}}</text></view>
          <view class="info-item"><text class="label">å…¨å±€æˆé•¿å€¼</text><text class="value">{{treeDetailData.totalGrowthValueGlobal || 0}}</text></view>
          <view class="info-item"><text class="label">å…¨å±€æµ‡æ°´æ¡¶æ•°</text><text class="value">{{treeDetailData.totalWaterAmountGlobal || 0}}</text></view>
          <view class="info-item"><text class="label">æˆ‘çš„æˆé•¿å€¼</text><text class="value">{{treeDetailData.myGrowthValue || 0}}</text></view>
          <view class="info-item"><text class="label">æˆ‘æµ‡çš„æ¡¶æ•°</text><text class="value">{{treeDetailData.myWaterAmount || 0}}</text></view>
        </view>
      </view>
      <view class="tree-actions">
        <view class="action-btn primary" bindtap="waterTreeFromDetail">å»æµ‡æ°´</view>
        <view class="action-btn ghost" bindtap="closeTreeDetail">å…³é—­</view>
      </view>
    </view>
  </view>
</view>